let e;const t={},l=function(l){var n,o;t.hasOwnProperty(l)&&(n=t[l],(o=e.createBufferSource()).buffer=n,o.connect(e.destination),o.start())},n=document.querySelector("body");let o=function(){function l(l){var n=new XMLHttpRequest;n.open("GET",l+".m4a",!0),n.responseType="arraybuffer",n.onload=function(){var o=n.response;e.decodeAudioData(o,function(e){t[l]=e},function(e){})},n.send()}n.removeEventListener("keypress",o),e=new(window.AudioContext||window.webkitAudioContext),l("keys"),l("flashlight"),l("data"),l("win"),l("door-locked")};n.addEventListener("keypress",o);const i=document.querySelector("body"),r=function(e,t){let l=document.createElement(e);return t&&(Array.isArray(t)?t.forEach(e=>l.classList.add(e)):l.classList.add(t)),l},s=r("div","game");i.appendChild(s);const a=function(e,t){var l={row:e,col:t,element:r("div","player"),inventory:{items:[],element:r("div","inventory")}};return l.element.appendChild(l.inventory.element),l},d=function(e,t){var l=t||g;return e.row<0||e.row>=l.height?null:e.col<0||e.col>=l.width?null:e.row*l.width+e.col},c=function(e){var t=d(e);return null===t?null:g.cells[t]},h=function(e,t){var l=e.indexOf(t);l>-1&&e.splice(l,1)},m=function(e){let t=e.element;t.parentNode&&t.parentNode.removeChild(t)},u=function(e,t){let n=!1;return e.items.map(n=>n.collectible?()=>(function(e,t,n){let o=n.inventory.items,i=n.inventory.element;return t.row=0,t.col=o.length,o.push(t),m(t),i.appendChild(t.element),l(t.name),h(e.items,t),!1})(e,n,t):"exit"===n.name?()=>(function(e,t){if(!e.locked)return!1;let n=t.inventory.items.filter(e=>"keys"===e.name);if(0===n.length)return l("door-locked"),!0;e.locked=!1;let o=n[0];return m(o),delete o,!1})(n,t):"system"===n.name?()=>(function(e,t){if(!1===e.booted){let n=t.inventory.items.filter(e=>"data"===e.name);if(0===n.length)alert("in order to reboot the system, you need to find the data disk");else{l("data"),e.booted=!0;let t=n[0];m(t),delete t}}return!0})(n,t):"filing-cabinet"===n.name?()=>u(n,t):"desk"===n.name?()=>(M.pickedUp||(M.render(),M.pickedUp=!0),!0):void 0).forEach(e=>{e&&(n=n||e())}),!n},w=function(e){let t=50*e.col,l=50*e.row;g.element.style.transform="translate(-"+t+"px,-"+l+"px)"},f=function(e){const t=c(v);let n={row:v.row,col:v.col};"w"===e.key&&-1===t.walls.indexOf("top")?n.row=v.row-1:"a"===e.key&&-1===t.walls.indexOf("left")?n.col=v.col-1:"s"===e.key&&-1===t.walls.indexOf("bottom")?n.row=v.row+1:"d"===e.key&&-1===t.walls.indexOf("right")&&(n.col=v.col+1);let o=c(n);if(t!==o){A(1);let l=u(o,v);"w"===e.key&&o.walls.indexOf("bottom")>=0?l=!1:"a"===e.key&&o.walls.indexOf("right")>=0?l=!1:"s"===e.key&&o.walls.indexOf("top")>=0?l=!1:"d"===e.key&&o.walls.indexOf("bottom")>=0&&(l=!1),l?(v.row=n.row,v.col=n.col,h(t.items,v),o.items.push(v),function(){m(v);const e=d(v);g.cells[e].element.appendChild(v.element)}()):o=t}!function(e,t,l){if(0===l.inventory.items.filter(e=>"flashlight"===e.name).length)return;let n=-1!=e.walls.indexOf("left"),o=-1!=e.walls.indexOf("right"),i=-1!=e.walls.indexOf("top"),r=-1!=e.walls.indexOf("bottom"),s=c({row:e.row-1,col:e.col-1});!s||n||i||s.element.setAttribute("light-level","25"),(s=c({row:e.row-1,col:e.col-0}))&&!i&&s.element.setAttribute("light-level","25"),!(s=c({row:e.row-1,col:e.col+1}))||o||i||s.element.setAttribute("light-level","25"),!(s=c({row:e.row+1,col:e.col-1}))||n||r||s.element.setAttribute("light-level","25"),(s=c({row:e.row+1,col:e.col-0}))&&!r&&s.element.setAttribute("light-level","25"),!(s=c({row:e.row+1,col:e.col+1}))||r||o||s.element.setAttribute("light-level","25"),(s=c({row:e.row-0,col:e.col-1}))&&!n&&s.element.setAttribute("light-level","25"),(s=c({row:e.row-0,col:e.col+1}))&&!o&&s.element.setAttribute("light-level","25"),n=-1!=t.walls.indexOf("left"),o=-1!=t.walls.indexOf("right"),i=-1!=t.walls.indexOf("top"),r=-1!=t.walls.indexOf("bottom"),!(s=c({row:t.row-1,col:t.col-1}))||n||i||s.element.setAttribute("light-level","25"),(s=c({row:t.row-1,col:t.col-0}))&&!i&&s.element.setAttribute("light-level","50"),!(s=c({row:t.row-1,col:t.col+1}))||o||i||s.element.setAttribute("light-level","25"),!(s=c({row:t.row+1,col:t.col-1}))||n||r||s.element.setAttribute("light-level","25"),(s=c({row:t.row+1,col:t.col-0}))&&!r&&s.element.setAttribute("light-level","50"),!(s=c({row:t.row+1,col:t.col+1}))||r||o||s.element.setAttribute("light-level","25"),(s=c({row:t.row-0,col:t.col-1}))&&!n&&s.element.setAttribute("light-level","50"),(s=c({row:t.row-0,col:t.col+1}))&&!o&&s.element.setAttribute("light-level","50"),t.element.setAttribute("light-level","75")}(t,o,v),w(v),function(e){const t=e.items.filter(e=>"exit"===e.name);0!==t.length&&(!1!==g.systemItem.booted?!1===t[0].locked&&(l("win"),setTimeout(()=>{alert("You have brought the system back online."),T()},0)):alert("you must boot the system before you can exit!"))}(o)},p=function(e,t,l,n,o){let i={row:e,col:t,name:l,collectible:n,element:r("div",["item",l])};return Object.keys(o||{}).forEach(e=>{if(i.hasOwnProperty(e))throw"cannot overwrite required property on item: "+e;i[e]=o[e]}),i};let v=null,g=null,y={moves:0,element:r("div","move-counter")};const x={0:"wall",16777215:"floor",16715007:"locked-door-boss",11665663:"filing-cabinet",65530:"unlocked-door",8421504:"window",16766976:"couch",5046016:"desk",16738816:"locked-door-security",16711684:"system",8323182:"player",4164863:"keys"},b=function(e,t){return Math.sqrt(Math.pow(t.row-e.row,2)+Math.pow(t.col-e.col,2))};const k=function(e,t){let l={width:e,height:t,element:r("div","grid"),cells:function(e,t){let l=[];for(let n=0;n<e;n++)for(let e=0;e<t;e++){let t={row:n,col:e,walls:[],items:[],element:r("div","cell")};t.element.appendChild(r("div","lights")),t.element.appendChild(r("div","walls")),l.push(t)}return l}(t,e)};return l.element.style.height=50*t+"px",l.element.style.width=50*e+"px",l},A=function(e){y.moves+=e,y.element.innerHTML="Moves: "+y.moves};let E=[];const O=function(e){E.push(e)},C=function(e){h(E,e)},L=function(t){e&&t.preventDefault(),(0,E[E.length-1])(t)},_=function(){i.setAttribute("view","game"),A(0),H.render()},T=function(){i.setAttribute("view","leaderboard")};class I{constructor(e){this.convo=e,this.index=0,this.element=r("div","dialog");const t=this;this.element.addEventListener("click",()=>t.moveTextNext()),this.textElement=r("div","text"),this.element.appendChild(this.textElement),this.avatarElement=r("div","avatar"),this.element.appendChild(this.avatarElement);let l=r("div","click-to-continue");l.innerHTML="Click or press space to continue...",this.element.appendChild(l),this.moveTextNext(),this.inputHandler=function(e){" "===e.key&&t.moveTextNext()}}render(){s.appendChild(this.element),O(this.inputHandler)}unrender(){m(this),C(this.inputHandler)}moveTextNext(){if(this.index>=this.convo.length)return void this.unrender();const e=this.convo[this.index];this.textElement.innerHTML=e.text,this.avatarElement.innerHTML=e.avatar,this.element.classList.remove("left"),this.element.classList.remove("right"),this.element.classList.add(e.side),this.index++}}var M=new I([{side:"left",avatar:"ðŸ§”",text:"Hey, are you awake?  I've been trying to call you for an hour!"},{side:"right",avatar:"ðŸ§ž",text:"Hey, what's going on? It's dark in here and my head is killing me!"},{side:"left",avatar:"ðŸ§”",text:"Why are you still in the office?"},{side:"right",avatar:"ðŸ§ž",text:"I don't know, whats.."},{side:"left",avatar:"ðŸ§”",text:"You know what, don't worry about it, that's not what matters right now..."},{side:"right",avatar:"ðŸ§ž",text:"What do you mean?  What's wrong?"},{side:"left",avatar:"ðŸ§”",text:"The power is out and the system is offline, WE'RE LOSING MONEY! AND WE'RE LOSING IT FAST!"},{side:"right",avatar:"ðŸ§ž",text:"How much do we have?  What can I do about it?"},{side:"left",avatar:"ðŸ§”",text:"Get the system back online, you need to collect the Windows 3.1 disks from around the office and restore the OS on the main server."},{side:"right",avatar:"ðŸ§ž",text:"But it's pitch black in here, I can't see anything.."},{side:"left",avatar:"ðŸ§”",text:"There's a flashlight in the filing cabinet near your desk, hurry up, we're counting on you!"}]),H=new I([{side:"left",avatar:"â˜Žï¸",text:"There's a phone on the desk ringing like crazy.  Why don't you pick it up..."}]);const N=function(){!function(e){const t=e.element;e.cells.forEach(e=>t.appendChild(function(e){const t=e.element;return e.items.forEach(e=>{t.appendChild(e.element)}),t}(e))),s.appendChild(t)}(g),s.appendChild(y.element),w(v),O(f),i.addEventListener("keydown",L),function(){let e=r("div","leaderboard"),t={element:e},l=r("button","play");l.innerHTML="PLAY!",e.appendChild(l),l.addEventListener("click",_),i.appendChild(t.element)}(),T()};!function(e,t){let l=new Image;l.src=e,l.onload=t}("world.png",function(e){_temp=document.createElement("canvas"),_temp.width=level_width=e.target.width,_temp.height=level_height=e.target.height,_temp=_temp.getContext("2d"),_temp.drawImage(this,0,0),_temp=_temp.getImageData(0,0,level_width,level_height).data,g=k(level_width,level_height);let t=[];for(let e=0;e<level_height;e++)for(let n=0;n<level_width;n++){let o=4*(e*level_width+n),i=(_temp[o]<<16)+(_temp[o+1]<<8)+_temp[o+2],r=x[""+i],s=g.cells[d({row:e,col:n})];if("wall"===r)s.walls=["top","left","right","bottom"],s.walls.forEach(e=>s.element.classList.add("wall-"+e));else if("locked-door-boss"===r)s.items.push(p(e,n,"exit",!1,{locked:!0}));else if("filing-cabinet"===r){var l=p(e,n,"filing-cabinet",!1,{items:[]});s.items.push(l),t.push(l)}else"unlocked-door"===r?s.items.push(p(e,n,"exit",!1,{locked:!1})):"window"===r?(s.walls=["top","left","right","bottom"],s.walls.forEach(e=>s.element.classList.add("wall-"+e)),s.items.push(p(e,n,"window",!1))):"couch"===r?s.items.push(p(e,n,"couch",!1)):"desk"===r?s.items.push(p(e,n,"desk",!1)):"locked-door-security"===r?s.items.push(p(e,n,"exit",!1,{locked:!0})):"system"===r?(g.systemItem=p(e,n,"system",!1,{booted:!1}),s.items.push(g.systemItem)):"player"===r?(v=a(e,n),s.items.push(v)):"keys"===r&&s.items.push(p(e,n,"keys",!0))}let n={dist:b(v,t[0]),fc:t[0]};for(let e=1;e<t.length;e++){let l=b(v,t[e]);l<n.dist&&(n.dist=l,n.fc=t[e])}var o=p(0,0,"flashlight",!0);n.fc.items.push(o);const i=p(0,0,"data",!0);var r;t[(r=t.length,Math.floor(Math.random()*Math.floor(r)))].items.push(i),setTimeout(N,1)});